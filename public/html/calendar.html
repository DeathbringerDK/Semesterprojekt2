<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <link href='../css/fullcalendar.min.css' rel='stylesheet' />
    <link href='../css/fullcalendar.print.min.css' rel='stylesheet' media='print' />
    <script src='../js/lib/moment.min.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="/js/testEvents.js"></script>
    <script src='../js/lib/fullcalendar.min.js'></script>

    <script>
        var color;
        var currentUser = localStorage.getItem('currentUser');
        if (currentUser != 'admin') {
            color = "#1E90FF";
        } else {
            color = "black";
        }
        $(document).ready(function() {

            $('#calendar').fullCalendar({
                height: "auto",
                defaultDate: $('#calendar').fullCalendar('today'),
                weekNumbers: true,
                weekNumbersWithinDays: true,
                weekNumberCalculation: 'ISO',
                viewRender: function(view, element) {
                    var now = new Date();
                    var end = new Date();
                    end.setMonth(now.getMonth() + 12); //Adjust as needed
                    now.setMonth(now.getMonth() - 3);
                    if (view.start < now) {
                        $('.fc-prev-button').addClass("fc-state-disabled");
                        return false;
                    } else {
                        $('.fc-prev-button').removeClass("fc-state-disabled");
                    }

                    if (end < view.end) {
                        $('.fc-next-button').addClass("fc-state-disabled");
                        return false;
                    } else {
                        $('.fc-next-button').removeClass("fc-state-disabled");
                    }
                },
                eventClick: function(event) {
                    var m = $.fullCalendar.moment(event.start);
                    m.stripTime();
                    var date = m.format();
                    console.log("** full date in event **" + date);
                    $.ajax({
                            url: '/calendarbookingdelete',
                            method: 'DELETE',
                            // ID skal også med HER - husk at hive id med ned fra server ved login.	
                            data: {
                                currentUser: localStorage.getItem('currentUser'),
                                checkUser: $(this).children('div').children('span')[0].innerHTML,
                                index: $(this).hasClass('fc-day-grid-event'),
                                date: date
                            }
                        })
                        .done(function(dataStr) {
                            var data = JSON.parse(dataStr);
                            console.log('from server: ', data);
                        });
                    var checkUser = $(this).children('div').children('span')[0].innerHTML;
                    if (currentUser == checkUser) {
                        $('#calendar').fullCalendar('removeEvents', event._id);
                    } else if (currentUser == 'admin') {
                        $('#calendar').fullCalendar('removeEvents', event._id);
                    }
                },
                selectable: true, // vælg datoer
                select: function(start, end) {

                    var eventData = {
                        title: currentUser, //username/id skal ind her, når det virker.
                        start: start,
                        color: color
                    };

                    $.ajax({
                            url: '/calendarbookingpost',
                            method: 'POST',
                            // ID skal også med HER - husk at hive id med ned fra server ved login.	
                            data: {
                                date: start.format(),
                                currentUser: localStorage.getItem('currentUser'),
                            }
                        })
                        .done(function(dataStr) {
                            var data = JSON.parse(dataStr);
                            console.log('from server: ', data);
                        });

                    $('#calendar').fullCalendar('renderEvent', eventData, true); // stick? = true


                    $('#calendar').fullCalendar('unselect'); // så man kan vælge igen. 
                },
                editable: false,
                eventLimit: true
            }); // allow "more" link when too many events
            initUnavailableDates();
        });

    </script>
    <style>
        body {
            max-width: 1200px;
            width: auto;
            margin-top: 40px;
            padding: 0;
            font-family: "Lucida Grande", Helvetica, Arial, Verdana, sans-serif;
            font-size: 14px;
        }
        
        #calendar {
            margin: 0 auto;
        }

    </style>
</head>

<body>
    <!--	<button type="button" onclick="initUnavailableDates()"></button>-->

    <div id='calendar'></div>

</body>

</html>
